<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Choose a City</title>
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.4.0/jquery.min.js"></script>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.8.0/dist/leaflet.css"
    integrity="sha512-hoalWLoI8r4UszCkZ5kL8vayOGVae1oxXe/2A4AO6J9+580uKHDO3JdHb7NzwwzK5xr/Fs0W40kiNHxM9vyTtQ=="
    crossorigin="" />
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.3.1/dist/css/bootstrap.min.css"
    integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" crossorigin="anonymous">
  <script src="https://unpkg.com/leaflet@1.8.0/dist/leaflet.js"
    integrity="sha512-BB3hKbKWOc9Ez/TAwyWxNXeoV9c1v6FIeYiBieIWkpLjauysF18NzgR1MBNBXf8/KABdlkX68nAhlwcDFLGPCQ=="
    crossorigin=""></script>
  <script src="https://kit.fontawesome.com/cd50251ae1.js" crossorigin="anonymous"></script>
  <!-- Showing Place Boundaries -->
  <script
    src="https://api.jawg.io/libraries/jawg-places@latest/jawg-places.js?access-token={{jawg_accessToken}}"></script>

  <style>
    html,
    body {
      margin: 0;
    }

    #map {
      height: 100vh;
      width: 100vw;
      position: absolute;
    }

    #exampleModalCenter {
      height: 100vh;
      width: 100vw;
      position: absolute;
      background-color: rgba(255, 255, 255, 0.9);
      z-index: 2000;
    }

    #kiosks {
      margin-left: 10px;
      margin-top: 10px;
      position: absolute;
      background-color: rgba(255, 255, 255, 0.9);
      z-index: 1000;
    }

<<<<<<< HEAD
=======
    #loading_heatmap {
      left: 50%;
      top: 10%;
      transform: translate(-50%, -50%);
      padding: 10px;
      position: absolute;
      background-color: rgba(255, 255, 255, 0.5);
      z-index: 10000;
      white-space: nowrap;
      font-size: 200%;
      border-radius: 15px;
    }

>>>>>>> 16e542cb80a12dbc07d397e144cccf175e1fdd42
    .panel {
      min-width: 30vw;
      max-height: 50vh;
      max-width: 30vw;
      overflow: scroll;
    }

    .container {
      border-radius: 10px;
      width: 40vw;
      max-width: 50vw;
    }

    .box {
      margin: 1.27836vw;
    }

    .my-custom-scrollbar {
      position: relative;
      max-height: 30vh;
      overflow: auto;
    }

    .btn-primary {
      display: block;
      color: #fff;
      background-color: #007bff;
      border-color: #007bff;
    }
    .btn-primary.disabled, .btn-primary:disabled {
      position: relative;
      color: #fff;
      background-color: #007bff;
      width: 20vh;
      border-color: #007bff;
      display: block;
    }

    #distancematrix {
      max-height: 30vh;
      max-width: 30vw;
      overflow: scroll;
    }

<<<<<<< HEAD
=======
    .loading-icon {
      z-index: 1000;
      padding-top: 5px;
    }
>>>>>>> 16e542cb80a12dbc07d397e144cccf175e1fdd42
  </style>
</head>

<body>
    <!-- Modal -->
  <div class="modal fade" id="showSubmitModal" tabindex="-1" role="dialog" aria-labelledby="showSubmitModalLabel" aria-hidden="true">
    <div class="modal-dialog" role="document">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="exampleModalLabel">Modal title</h5>
          <button type="button" class="close" data-dismiss="modal" aria-label="Close">
            <span aria-hidden="true">&times;</span>
          </button>
        </div>
        <div class="modal-body">
          <div class="form-group">
          <form id="createAnimationForm">
              <label for="city_name">City Name</label>
              <input id="city_name" type="text" name="city_name" required></input>
              <br />

              <label for="lst_fleetsize">Fleetsize(s)</label>
              <input id="lst_fleetsize" type="text" name="lst_fleetsize" value="100" required></input>
              <br />

              <label for="modesplit">Modesplit (%)</label>
              <input id="modesplit" type="number" name="modesplit" step="any" value="10" min="0" max="100" required></input>
              <small class="form-text text-muted">Randomly chooses X% of trips to serve using this network.</small>
              <br />
            <button type="submit" class="btn btn-primary">Submit</button>
          </form>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
        </div>
      </div>
    </div>
    
  </div>

  <div id="map">
  </div>
  <div class="container" id="kiosks">
    <div class="box">
      <label for="placeKiosksCheck">Place Kiosks?</label>
      <input type="checkbox" id="placeKiosksCheck"><br>
      <div class="my-custom-scrollbar" id="listkiosks">
        <div class="panel-heading">List of Kiosks:</div>
      </div>
      <div id="routenetwork">
        Number of road miles to map: <span id="num_road_miles"></span> <br>
        <!-- Least Dense<input id="routenetworkdensityslider" type="range" oninput="renderRoutes(this.value)">Most Dense -->
        <div id="distancematrix"></div><br>
        <!-- <button type="button" class="btn btn-info" onclick="duration_table_view='minutes'; updateDurationTable()">In Seconds</button> <button type="button" class="btn btn-info" onclick="duration_table_view='miles'; updateDurationTable()">In Miles</button> -->
      </div>
      <div class="btn-group" role="group" aria-label="Button Group">
        <button type="button" class="btn btn-primary" data-toggle="modal" data-target="#showSubmitModal">Simulate Trips</button>
        <button type="button" class="btn btn-danger" onclick="resetAll()">Reset All</button>
        <button type="button" class="btn btn-info" onclick="toggleLayer()">Layer</button>
      </div>
<<<<<<< HEAD
      <br> <br>
      <div class="loading-icon">
        <button class="btn btn-primary" type="button" disabled>
          <span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span>
          Loading...
=======
      <div class="loading-icon" id="loading_heatmap_icon">
        <button class="btn btn-primary" type="button" disabled>
          <span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span>
          Loading Heatmap...
>>>>>>> 16e542cb80a12dbc07d397e144cccf175e1fdd42
        </button>
      </div>
    </div>
  </div>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/heatmap.js/2.0.0/heatmap.min.js" integrity="sha512-FpvmtV53P/z7yzv1TAIVH7PNz94EKXs5aV6ts/Zi+B/VeGU5Xwo6KIbwpTgKc0d4urD/BtkK50IC9785y68/AA==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
  <script src="https://cdn.jsdelivr.net/npm/leaflet-heatmap@1.0.0/leaflet-heatmap.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/popper.js@1.14.7/dist/umd/popper.min.js" integrity="sha384-UO2eT0CpHqdSJQ6hJty5KVphtPhzWj9WO1clHTMGa3JDZwrnQq4sF86dIHNDz0W1" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.3.1/dist/js/bootstrap.min.js" integrity="sha384-JjSmVgyd0p3pXB1rRibZUAYoIIy6OrQ6VrjIEaFf/nJGzIxFDsf4x0xIM+B07jRM" crossorigin="anonymous"></script>
  <script>
    function resetAll() {
      window.location.reload();
    }

    function toggleLayer() {
      L.VirtualGrid = null;
      console.log('ocurr');
    }
    $("#kiosks").hide();
    $("#routenetwork").hide();
    var locality_name;
    var county_name;
    var state_name;
    var url_path;
    var center_lng_lat;
    var bbox;

    var mymap = L.map('map').setView([44.967243, -103.771556], 3);
    mymap.addLayer(new L.tileLayer('https://api.mapbox.com/styles/v1/{id}/tiles/{z}/{x}/{y}?access_token={accessToken}', {
      attribution: 'Map data &copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors, Imagery Â© <a href="https://www.mapbox.com/">Mapbox</a>',
      id: 'mapbox/streets-v11',
      accessToken: '{{mapbox_access_token}}'
    }));

    function fixMapBounds(lat1, lng1, lat2, lng2) {
      mymap.fitBounds([[lat1, lng1],
                      [lat2, lng2]]);
    }

    let jawgPlaces = new JawgPlaces.Leaflet({
      searchOnTyping: true,
      adminArea: {
        outlineColor: 'rgb(172,59,246)',
        show: true,
      },
      marker: {
        show: false,
      },
      sources: 'wof',
      transition: {
        type: 'jump',
      },
      onClick: (feature) => {
        $("#kiosks").show();
        locality_name = feature.properties.locality;
        county_name = feature.properties.county;
        state_name = feature.properties.region;
        center_lng_lat = feature.geometry.coordinates;
        bbox = feature.bbox;

        let locality_gid = feature.properties.locality_gid.split(":")[2];
        url_path = locality_gid.match(/.{1,3}/g).join("/") + "/" + locality_gid + ".geojson";

        fixMapBounds(feature.bbox[1], feature.bbox[0], feature.bbox[3], feature.bbox[2]);

        $("#city_name").val(locality_name+", "+state_name);

        getHeatmap();
      },
      L: L,
    });


    mymap.addControl(jawgPlaces);

    var markers = {};
    var circles = {};

    function moveToKiosk(marker_id) {
      mymap.setView(markers[marker_id].getLatLng());
    };

    function deleteKiosk(marker_id) {
      mymap.removeLayer(markers[marker_id]);
      mymap.removeLayer(circles[marker_id]);
      delete markers[marker_id];
      delete circles[marker_id];
      $("#panel_"+marker_id).remove();
      renderRoutes();
      if (Object.keys(markers).length == 1) {
        $("#routenetwork").hide();
      }
    }


    function placeKiosk(e) {
      if ($('#placeKiosksCheck').is(':checked')) {
        $('#routenetwork').show();

        var marker = L.marker(e.latlng, {
          draggable: true,
          autoPan: true,
        }).addTo(mymap);
        marker.on('drag', function(e){
          circles[marker._leaflet_id].setLatLng(e.latlng);
          $('#'+marker._leaflet_id).text(e.latlng.lat.toFixed(5) + ";" + e.latlng.lng.toFixed(5));
        });
        markers[marker._leaflet_id] = marker;
        marker.on('dragend', function(e){
          addMarker(markers, marker._leaflet_id);
          console.log("Marker ID is " + marker._leaflet_id);
        });
        var circle = L.circle(e.latlng, {
          color: 'red',
          fillColor: '#f03',
          fillOpacity: 0.3,
          radius: 402.336 // 0.25 miles in meters
        }).addTo(mymap);
        circles[marker._leaflet_id] = circle;

        $("#listkiosks").append('<div class="panel-body" id="panel_'+marker._leaflet_id+'"><button type="button" class="btn btn-outline-info" onclick="moveToKiosk('+ marker._leaflet_id +')"><span id="' + marker._leaflet_id + '">' + e.latlng.lat.toFixed(5) + ";" + e.latlng.lng.toFixed(5) + '</span></button><button onclick="deleteKiosk('+marker._leaflet_id+')"><i class="fa-solid fa-trash-can fa-lg"></i></button></div>');

        addMarker(markers, marker._leaflet_id);
      }
    };

    function renderHeatmap(response) {
      var heatmap_data = response;
      var cfg = {
        // radius should be small ONLY if scaleRadius is true (or small radius is intended)
        // if scaleRadius is false it will be the constant radius used in pixels
        "radius": 50,
        "maxOpacity": .8,
        // scales the radius based on map zoom
        "scaleRadius": false,
        // if set to false the heatmap uses the global maximum for colorization
        // if activated: uses the data maximum within the current map boundaries
        //   (there will always be a red spot with useLocalExtremas true)
        "useLocalExtrema": false,
        // which field name in your data represents the latitude - default "lat"
        latField: 'lat',
        // which field name in your data represents the longitude - default "lng"
        lngField: 'lng',
        // which field name in your data represents the data value - default "value"
        valueField: 'count'
      };
      var heatmapLayer = new HeatmapOverlay(cfg);
      heatmapLayer.addTo(mymap);
      heatmapLayer.setData(heatmap_data);
      $('#loading_heatmap_icon').hide();
    };


    function makeTableHTML(myArray) {
      var result = "<table class='table table-bordered w-auto'>";
      for(var i=0; i<myArray.length; i++) {
          result += "<tr>";
          for(var j=0; j<myArray[i].length; j++){
              result += "<td>"+myArray[i][j]+"</td>";
          }
          result += "</tr>";
      }
      result += "</table>";

      return result;
    }

    var curr_route_key;

    // var duration_table_view = 'minutes';
    // function updateDurationTable() {
    //   if (duration_table_view == 'minutes') {
    //     $('#distancematrix').html(makeTableHTML(routes_dict[curr_route_key].duration_matrix_minutes));
    //   }
    //   else {
    //     $('#distancematrix').html(makeTableHTML(routes_dict[curr_route_key].duration_matrix_multiple));
    //   }
    // }

    function cleanRouteDicts() {
      var lst_latlngs = [];
      for (let key in markers) {
        latlng = markers[key].getLatLng();
        lst_latlngs.push([latlng.lat, latlng.lng]);
      }
      for (key in routes_dict) {
        str_lat_lng1 = key.split(";")[0].split(",");
        lat_lng1 = [parseFloat(str_lat_lng1[0]), parseFloat(str_lat_lng1[1])];
        str_lat_lng2 = key.split(";")[1].split(",");
        lat_lng2 = [parseFloat(str_lat_lng2[0]), parseFloat(str_lat_lng2[1])];
        if (!(lst_latlngs.some(elem => JSON.stringify(elem) === JSON.stringify(lat_lng1)) && lst_latlngs.some(elem => JSON.stringify(elem) === JSON.stringify(lat_lng2)))) {
          delete routes_dict[key];
        }
      }
    }

    var allRouteLayerGroups = {};
    var total_distance = 0;

    var routeLayerGroup = L.layerGroup().addTo(mymap);
    function renderRoutes() {
      cleanRouteDicts();
      total_distance = 0;
      routeLayerGroup.clearLayers();
      for (let key in routes_dict) {
        let latlngs = routes_dict[key].latlngs;
        let distance = routes_dict[key].distance / 1609.34; // convert from meters to miles
        total_distance += distance;
        let duration = routes_dict[key].duration / 60; // convert from seconds to minutes
        var polyline = L.polyline(latlngs, {color: 'blue', weight: 3}).bindTooltip("Distance: <b>"+distance.toFixed(2)+" miles</b><br>Duration: <b>"+duration.toFixed(2)+" minutes</b>", {
        	sticky: true
        }).addTo(routeLayerGroup);
        polyline.on('mouseover', function(e) {
          var layer = e.target;
          layer.setStyle({
              color: 'red',
              weight: 5
          });
        });
        polyline.on('mouseout', function(e) {
          var layer = e.target;
          layer.setStyle({
              color: 'blue',
              weight: 3
          });
        });
      }
      $('#num_road_miles').text(total_distance.toFixed(2));
      //updateDurationTable();
    }

    var request_routes = null;
    function addMarker(lst_markers, new_marker_key) {
      var lst_latlngs = [];
      for (let key in lst_markers) {
        latlng = lst_markers[key].getLatLng();
        lst_latlngs.push([latlng.lat, latlng.lng]);
      }
      let new_marker = [lst_markers[new_marker_key].getLatLng().lat, lst_markers[new_marker_key].getLatLng().lng];
      lst_latlngs_encoded = encodeURIComponent(lst_latlngs);
      var url = '/get_routes?lst_latlngs=' + lst_latlngs_encoded
        + '&new_marker=' + new_marker

      request_routes = $.ajax(
        {
          type: 'GET',
          url: url,
          success: addNewRoutes
        }
      );
    }

    var routes_dict = {};
    function addNewRoutes(response) {
      Object.assign(routes_dict, response);
      renderRoutes();
    }

    var request_heatmap = null;
    function getHeatmap() {
      county_name = encodeURIComponent(county_name);
      state_name = encodeURIComponent(state_name);
      bbox = encodeURIComponent(bbox);

      var url = '/get_heatmap?county_name=' + county_name
        + '&state_name=' + state_name
        + '&bbox=' + bbox

      console.log(url);

      if (request_heatmap != null) {
           request_heatmap.abort();
      };

      request_heatmap = $.ajax(
        {
          type: 'GET',
          url: url,
          success: renderHeatmap
        }
      );
    }

    var request_submit_kiosks = null;
    $("#createAnimationForm").submit(function(e) {
      e.preventDefault();
      submitKiosks();
    });

    function handleSubmitKiosk() {
      alert("Animation is created");
    }

    function submitKiosks() {
      var lst_marker_latlngs = [];
      for (let key in markers) {
        latlng = markers[key].getLatLng();
        lst_marker_latlngs.push([latlng.lat, latlng.lng]);
      }
      city_name = encodeURIComponent(locality_name);
      county_name = encodeURIComponent(county_name);
      state_name = encodeURIComponent(state_name);
      url_path = encodeURIComponent(url_path);
      center_lng_lat = encodeURIComponent(center_lng_lat);
      lst_marker_latlngs = encodeURIComponent(lst_marker_latlngs);
      console.log(routes_dict);
      let routes_dict_converted_to_lst = [];
      for (let key in routes_dict) {
        routes_dict_converted_to_lst.push([key.replaceAll(",",":"), "latlngs", routes_dict[key]["latlngs"], "distance", routes_dict[key]["distance"], "duration", routes_dict[key]["duration"]]);
      }

      console.log(routes_dict_converted_to_lst);

      var url = '/create_simulation?city_name=' + city_name
        + '&county_name=' + county_name
        + '&state_name=' + state_name
        + '&url_path=' + url_path
        + '&center_lng_lat=' + center_lng_lat
        + '&lst_latlngs=' + lst_marker_latlngs
        + '&routes_dict_converted_to_lst=' + routes_dict_converted_to_lst

      console.log(url);

      request_submit_kiosks = $.ajax(
        {
          type: 'POST',
          url: url,
          success: handleSubmitKiosk
        }
      );
    }

    mymap.on('click', placeKiosk);

    mymap.zoomControl.setPosition('bottomright');

    L.control.scale().addTo(mymap);

  </script>
</body>

</html>
