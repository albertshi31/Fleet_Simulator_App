<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Choose a City</title>
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.4.0/jquery.min.js"></script>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.8.0/dist/leaflet.css"
    integrity="sha512-hoalWLoI8r4UszCkZ5kL8vayOGVae1oxXe/2A4AO6J9+580uKHDO3JdHb7NzwwzK5xr/Fs0W40kiNHxM9vyTtQ=="
    crossorigin="" />
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.3.1/dist/css/bootstrap.min.css"
    integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" crossorigin="anonymous">
  <script src="https://unpkg.com/leaflet@1.8.0/dist/leaflet.js"
    integrity="sha512-BB3hKbKWOc9Ez/TAwyWxNXeoV9c1v6FIeYiBieIWkpLjauysF18NzgR1MBNBXf8/KABdlkX68nAhlwcDFLGPCQ=="
    crossorigin=""></script>
  <script src="https://kit.fontawesome.com/cd50251ae1.js" crossorigin="anonymous"></script>
  <!-- Showing Place Boundaries -->
  <script
    src="https://api.jawg.io/libraries/jawg-places@latest/jawg-places.js?access-token={{jawg_accessToken}}"></script>

  <!-- Todo: CHECK WHICH FILES WE DON'T NEED -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/Leaflet.awesome-markers/2.0.2/leaflet.awesome-markers.js"></script>
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.6.3/css/font-awesome.min.css"/>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/Leaflet.awesome-markers/2.0.2/leaflet.awesome-markers.css"/>
  <link rel="stylesheet" href="http://code.ionicframework.com/ionicons/1.5.2/css/ionicons.min.css"/>

  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/leaflet-draw@1.0.4/dist/leaflet.draw.css" integrity="sha256-XzD3RpaHPv7lzX9qt+2n1j5cWj48O24KsgaGYpKN8x8=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/leaflet-draw@1.0.4/dist/leaflet.draw-src.css" integrity="sha256-JBlDzNUHnqsTarTjdS7g5qm7Q/Kpxizyp6TBnz2NAhI=" crossorigin="anonymous">

  <link rel="stylesheet" href="/static/assets/css/leaflet.photon.css"/>

  <style>
    html,
    body {
      margin: 0;
    }

    #map {
      height: 100vh;
      width: 100vw;
      position: absolute;
    }

    #kiosks {
      margin-left: 10px;
      margin-top: 10px;
      position: absolute;
      background-color: rgba(255, 255, 255, 0.9);
      z-index: 1000;
    }

    #loading_heatmap {
      left: 50%;
      top: 10%;
      transform: translate(-50%, -50%);
      padding: 10px;
      position: absolute;
      background-color: rgba(255, 255, 255, 0.5);
      z-index: 10000;
      white-space: nowrap;
      font-size: 200%;
      border-radius: 15px;
    }

    .panel {
      min-width: 30vw;
      max-height: 50vh;
      max-width: 30vw;
      overflow: scroll;
    }

    .container {
      border-radius: 10px;
      width: 35vw;
      max-width: 50vw;
    }

    .box {
      margin: 1.27836vw;
    }

    .my-custom-scrollbar {
      position: relative;
      max-height: 30vh;
      overflow: auto;
    }

    .btn-primary {
      color: #fff;
      background-color: #007bff;
      border-color: #007bff;
    }
    .btn-primary.disabled, .btn-primary:disabled {
      position: relative;
      color: #fff;
      background-color: #007bff;
      width: 20vh;
      border-color: #007bff;
      display: block;
    }

    #distancematrix {
      max-height: 30vh;
      max-width: 30vw;
      overflow: scroll;
    }

    .loading-icon {
      padding-top: 5px;
    }

  </style>
</head>

<body>
  <div class="modal fade" id="showSubmitModal" tabindex="-1" role="dialog" aria-labelledby="showSubmitModalLabel" aria-hidden="true">
    <div class="modal-dialog" role="document">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="exampleModalLabel">Create Simulation</h5>
          <button type="button" class="close" data-dismiss="modal" aria-label="Close">
            <span aria-hidden="true">&times;</span>
          </button>
        </div>
        <div class="modal-body" id="submitModalBody">
          <div class="form-group">
          <form id="createAnimationForm">
              <label for="odd_name">ODD Name</label>
              <input id="odd_name" type="text" name="odd_name" required></input>
              <br />

              <label for="fleetsize">Fleetsize</label>
              <input id="fleetsize" type="text" name="fleetsize" value="100" required></input>
              <br />

              <label for="modesplit">Modesplit (%)</label>
              <input id="modesplit" type="number" name="modesplit" step="any" value="10" min="0" max="100" required></input>
              <small class="form-text text-muted">Randomly chooses X% of trips to serve using this network.</small>
              <br />

              <label for="pax_waittime_threshold">Passenger Waittime Threshold (seconds)</label>
              <input id="pax_waittime_threshold" type="number" name="pax_waittime_threshold" value="300" required></input>
              <small class="form-text text-muted">Amount of time passengers wait before they leave.</small>
              <br />

              <label for="max_circuity">Max Circuity (%)</label>
              <input id="max_circuity" type="number" name="max_circuity" step="any" value="20" min="0" max="100" required></input>
              <small class="form-text text-muted">Amount of additional travel time passengers are willing to tolerate in carpooling.</small>
              <br />

              <label for="max_capacity">Max Vehicle Capacity</label>
              <input id="max_capacity" type="number" name="max_capacity" step="1" value="4" min="0" max="20" disabled></input>
              <small class="form-text text-muted">Number of seats in vehicle.</small>
              <br />

            <button type="submit" class="btn btn-primary">Submit</button>
          </form>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
        </div>
      </div>
    </div>
  </div>

  <div class="modal fade" id="showPromptNewKioskModal" tabindex="-1" role="dialog" aria-labelledby="showPromptNewKioskModal" aria-hidden="true">
    <div class="modal-dialog" role="document">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="exampleModalLabel">Enter New Kiosk</h5>
          <button type="button" class="close" data-dismiss="modal" aria-label="Close">
            <span aria-hidden="true">&times;</span>
          </button>
        </div>
        <div class="modal-body" id="showPromptNewKioskModalBody">
          <div class="form-group">
          <form id="createNewKioskForm">
              <label for="kiosk_name">Name</label>
              <input id="kiosk_name" type="text" name="kiosk_name" required></input>
              <br />

              <label for="kiosk_category">Select Category</label>
              <select class="form-control" id="kiosk_category">
                <option>Residential</option>
                <option>School</option>
                <option>Commercial</option>
              </select>

              <label for="location">Location</label>
              <div class="input-group">
                <div class="input-group-prepend">
                  <span class="input-group-text" id="">Lat, Lng</span>
                </div>
                <input type="float" class="form-control" id="showPromptNewKioskModalBodyLat">
                <input type="float" class="form-control" id="showPromptNewKioskModalBodyLng">
              </div>

              <button type="button" class="btn btn-info" onclick="selectKioskLocationOnMapHandler()">Select Location on Map</button>

          </form>
          </div>
        </div>
        <div class="modal-footer">
          <button onclick="createNewKioskFormHandler()" class="btn btn-primary">Create Kiosk</button>
          <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
        </div>
      </div>
    </div>
  </div>

  <div class="modal fade" id="showPromptNewPOIModal" tabindex="-1" role="dialog" aria-labelledby="showPromptNewPOIModal" aria-hidden="true">
    <div class="modal-dialog" role="document">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="exampleModalLabel">Enter New POI</h5>
          <button type="button" class="close" data-dismiss="modal" aria-label="Close">
            <span aria-hidden="true">&times;</span>
          </button>
        </div>
        <div class="modal-body" id="showPromptNewPOIModalBody">
          <div class="form-group">
          <form id="createNewPOIForm">
              <label for="POI_name">Name</label>
              <input id="POI_name" type="text" name="POI_name" required></input>
              <br />

              <label for="POI_address">Address</label>
              <input id="POI_address" type="text" name="POI_address" required></input>
          </form>
          </div>
        </div>
        <div class="modal-footer">
          <button onclick="createNewPOIFormHandler()" class="btn btn-primary">Create POI</button>
          <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
        </div>
      </div>
    </div>
  </div>

  <div class="modal fade" id="showPromptEditKioskModal" tabindex="-1" role="dialog" aria-labelledby="showPromptEditKioskModal" aria-hidden="true">
    <div class="modal-dialog" role="document">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="exampleModalLabel">Edit Kiosk</h5>
          <button type="button" class="close" data-dismiss="modal" aria-label="Close">
            <span aria-hidden="true">&times;</span>
          </button>
        </div>
        <div class="modal-body" id="showPromptEditKioskModalBody">
          <div class="form-group">
          <form id="editKioskForm">
              <label for="editKioskForm_kiosk_name">Name</label>
              <input id="editKioskForm_kiosk_name" type="text" name="kiosk_name" required></input>
              <br />

              <label for="editKioskForm_kiosk_category">Select Category</label>
              <select class="form-control" id="editKioskForm_kiosk_category">
                <option>Residential</option>
                <option>School</option>
                <option>Commercial</option>
              </select>

              <div class="input-group">
                <div class="input-group-prepend">
                  <span class="input-group-text">Lat, Lng</span>
                </div>
                <input type="float" class="form-control" id="editKioskForm_lat">
                <input type="float" class="form-control" id="editKioskForm_lng">
              </div>

              <button type="button" class="btn btn-info" onclick="editKioskLocationOnMapHandler()">Select Location on Map</button>

          </form>
          </div>
        </div>
        <div class="modal-footer">
          <button onclick="editKioskFormHandler()" class="btn btn-primary">Edit Kiosk</button>
          <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
        </div>
      </div>
    </div>
  </div>


  <div id="map">
  </div>
  <div class="container" id="kiosks">
    <div class="box">
      <!-- <div id="avoidLocationsDiv">
        <input type="checkbox" name="avoidLocationsCheckbox" id="avoidLocationsCheckbox">
        <label for="avoidLocationsCheckbox">Add Locations to Avoid</label>
      </div> -->
      <div class="my-custom-scrollbar" id="regions">
        <div class="panel-heading">Regions:</div>
      </div>

      <button type="button" class="btn btn-primary" onclick="getAutoKiosks()">Auto Generate Kiosks</button>

      <button type="button" class="btn btn-primary" data-toggle="modal" data-target="#showPromptNewKioskModal">Add Kiosk</button>
      <!-- <button type="button" class="btn btn-info" data-toggle="modal" data-target="#showPromptNewPOIModal">Add POI</button> -->

      <div class="my-custom-scrollbar">
        <div class="panel-heading">List of Kiosks:</div>
        <div id="listkiosks">
        </div>
      </div>
      <div id="routenetwork">
        <!-- Number of road miles to map: <span id="num_road_miles"></span> <br>
        Number of Person Trips Served by Kiosk Network: <span id="numTripsInKioskNetwork"></span> <br> -->
        <!-- Least Dense<input id="routenetworkdensityslider" type="range" oninput="renderRoutes(this.value)">Most Dense -->
        <!-- <div id="distancematrix"></div><br> -->
        <!-- <button type="button" class="btn btn-info" onclick="duration_table_view='minutes'; updateDurationTable()">In Seconds</button> <button type="button" class="btn btn-info" onclick="duration_table_view='miles'; updateDurationTable()">In Miles</button> -->
      </div>

      <!-- <div id="connectKiosksDiv">
        Marker 1: <span id="connectKiosksDiv_marker1"></span><br />
        Marker 2: <span id="connectKiosksDiv_marker2"></span><br /> --->
      <!-- </div> --->
      <button type="button" class="btn btn-info" onclick="getRoute()" id="connect_kiosks_button">Connect Kiosks</button>
      <br />
      <div class="btn-group" role="group" aria-label="Button Group">
        <button id="simulate_trips_button" type="button" class="btn btn-primary" data-toggle="modal" data-target="#showSubmitModal" disabled>Simulate Trips</button>
        <!-- <button type="button" class="btn btn-primary" onclick="saveODD()">Save ODD</button> -->
        <button type="button" class="btn btn-danger" onclick="resetAll()">Reset All</button>
      </div>
      <div class="loading-icon" id="loading_heatmap_icon">
        <button class="btn btn-primary" type="button" disabled>
          <span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span>
          Loading Heatmap...
        </button>
      </div>
      <div class="loading-icon" id="loading_kiosks_icon">
        <button class="btn btn-primary" type="button" disabled>
          <span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span>
          Loading Kiosks...
        </button>
      </div>
      <div class="loading-icon" id="loading_road_network_icon">
        <button class="btn btn-primary" type="button" disabled>
          <span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span>
          Connecting Kiosks...
        </button>
      </div>
    </div>
  </div>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/heatmap.js/2.0.0/heatmap.min.js" integrity="sha512-FpvmtV53P/z7yzv1TAIVH7PNz94EKXs5aV6ts/Zi+B/VeGU5Xwo6KIbwpTgKc0d4urD/BtkK50IC9785y68/AA==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
  <script src="https://cdn.jsdelivr.net/npm/leaflet-heatmap@1.0.0/leaflet-heatmap.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/popper.js@1.14.7/dist/umd/popper.min.js" integrity="sha384-UO2eT0CpHqdSJQ6hJty5KVphtPhzWj9WO1clHTMGa3JDZwrnQq4sF86dIHNDz0W1" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.3.1/dist/js/bootstrap.min.js" integrity="sha384-JjSmVgyd0p3pXB1rRibZUAYoIIy6OrQ6VrjIEaFf/nJGzIxFDsf4x0xIM+B07jRM" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/leaflet-draw@1.0.4/dist/leaflet.draw.js" integrity="sha256-siofc4Uwjlra3YWkwthOn8Uj69cNN4aMug/iOHNiRgs=" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/leaflet-draw@1.0.4/dist/leaflet.draw-src.js" integrity="sha256-4AeXJ4ZcroXHUXhkzvfLu0Kj8Q91SsATFlOmZvCknlc=" crossorigin="anonymous"></script>


  <script src="/static/assets/js/leaflet.photon.js"></script>
  <script>
    function resetAll() {
      window.location.reload();
    }

    function toggleLayer() {
      L.VirtualGrid = null;
      console.log('ocurr');
    }
    $("#kiosks").hide();
    $("#routenetwork").hide();
    $('#loading_road_network_icon').hide();
    $('#loading_heatmap_icon').hide();
    $('#loading_kiosks_icon').hide();
    $('#simulate_trips_button').prop('disabled', true);
    $('#connect_kiosks_button').prop('disabled', true);

    var locality_name;
    var county_name;
    var state_name;
    var feature_geojson_url_path;
    var center_coordinates = {};
    var odd_choice_dir = {{odd_choice_dir}};

    var mymap = L.map('map').setView([44.967243, -103.771556], 3);

    var redMarker = L.AwesomeMarkers.icon({
      markerColor: 'red'
    });

    var avoidLocationsLayerGroup = L.layerGroup().addTo(mymap);
    function addLocationsToAvoid(e) {
      if ($('#avoidLocationsCheckbox').prop('checked')) {
        var marker = L.marker(e.latlng, {
          icon: redMarker
        }).addTo(avoidLocationsLayerGroup);
        console.log("Added avoid locations marker");

        marker.on('click', function(e){
          avoidLocationsLayerGroup.removeLayer(marker);
        });
      }
    }

    mymap.addLayer(new L.tileLayer('https://api.mapbox.com/styles/v1/{id}/tiles/{z}/{x}/{y}?access_token={accessToken}', {
      attribution: 'Map data &copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors, Imagery Â© <a href="https://www.mapbox.com/">Mapbox</a>',
      id: 'mapbox/streets-v11',
      accessToken: '{{mapbox_access_token}}'
    }));

    function fixMapBounds(lat1, lng1, lat2, lng2) {
      mymap.fitBounds([[lat1, lng1],
                      [lat2, lng2]]);
    }

    var regionsFeatureGroup = L.featureGroup().addTo(mymap);

    var regions = {};
    var regions_osm_geojsons = [];

    function moveToRegion(region_id) {
      mymap.fitBounds(regions[region_id].getBounds());
    };

    function deleteRegion(region_id) {
      regionsFeatureGroup.removeLayer(regions[region_id]);
      delete regions[region_id];
      // Route Network is not up to date, must first connect kiosks before running simulation
      // Make sure to enable connect kiosks button
      $("#panel_"+region_id).remove();
      $('#connect_kiosks_button').prop('disabled', false);
      // Update the pixel grid
      drawPixelGrid();
    };

    function addRegion(response_geojson) {
      let new_region = L.geoJSON(response_geojson).addTo(regionsFeatureGroup);
      regions[new_region._leaflet_id] = new_region;
      regions_osm_geojsons.push(response_geojson["features"][0]);
      console.log(response_geojson["features"][0]);
      $("#regions").append('<div class="panel-body" id="panel_'+new_region._leaflet_id+'"><button type="button" class="btn btn-outline-info" onclick="moveToRegion('+new_region._leaflet_id+')">'+response_geojson["features"][0]["properties"]["display_name"]+'</button><button onclick="deleteRegion('+new_region._leaflet_id+')"><i class="fa-solid fa-trash-can fa-lg"></i></button></div>');
      mymap.fitBounds(regionsFeatureGroup.getBounds());
      // Update the pixel grid
      drawPixelGrid();
    };

    function photonSearchControlHandler(geojson) {
      $('#kiosks').show();
      let osm_type = geojson["properties"]["osm_type"];
      let osm_id = geojson["properties"]["osm_id"];

      request_photon_search_handler = $.ajax({
        url: 'https://nominatim.openstreetmap.org/lookup?osm_ids=' + osm_type + osm_id + '&polygon_geojson=1&format=geojson',
        success: addRegion
      });
    };

    var photonControlOptions = {
      placeholder: 'Search for locality...',
      position: 'topright',
      includePosition: false,
      onSelected: photonSearchControlHandler,
      feedbackEmail: null,
    }

    var searchControl = new L.Control.Photon(photonControlOptions);
    searchControl.addTo(mymap);

    // FeatureGroup is to store editable layers
     var drawnItems = new L.FeatureGroup();
     mymap.addLayer(drawnItems);
     var drawControl = new L.Control.Draw({
        position: 'topright',
        draw: {
             polyline: false,
             circle: false,
             marker: false,
             circlemarker: false
        },
        edit: {
           featureGroup: drawnItems
        }
     });
     mymap.addControl(drawControl);

     mymap.on(L.Draw.Event.CREATED, function (e) {
      var layer = e.layer;
      console.log(layer.toGeoJSON());
      regions_osm_geojsons.push(layer.toGeoJSON());
      drawnItems.addLayer(layer);
      // Update the pixel grid
      drawPixelGrid();
     });

     mymap.on('draw:edited', function (e) {
      // Update the pixel grid
      drawPixelGrid();
     });

     mymap.on('draw:deleted', function (e) {
       // Update the pixel grid
       drawPixelGrid();
     });

    // let jawgPlaces = new JawgPlaces.Leaflet({
    //   searchOnTyping: true,
    //   adminArea: {
    //     outlineColor: 'rgb(172,59,246)',
    //     show: true,
    //   },
    //   marker: {
    //     show: false,
    //   },
    //   sources: 'wof',
    //   transition: {
    //     type: 'jump',
    //   },
    //   onClick: (feature) => {
    //     $("#kiosks").show();
    //     console.log(feature);
    //     locality_name = feature.properties.locality;
    //     county_name = feature.properties.county;
    //     state_name = feature.properties.region;
    //     center_coordinates["lat"] = feature.geometry.coordinates[1];
    //     center_coordinates["lng"] = feature.geometry.coordinates[0];
    //     console.log(center_coordinates);
    //     bbox = feature.bbox;
    //     console.log(bbox);
    //     console.log(feature.properties.locality_gid);
    //
    //     let locality_gid = feature.properties.locality_gid.split(":")[2];
    //     feature_geojson_url_path = locality_gid.match(/.{1,3}/g).join("/") + "/" + locality_gid + ".geojson";
    //
    //     fixMapBounds(bbox[1], bbox[0], bbox[3], bbox[2]);
    //
    //     $("#odd_name").val(locality_name+", "+state_name);
    //
    //     drawPixelGrid();
    //   },
    //   L: L,
    // });


    //mymap.addControl(jawgPlaces);

    var markers = {};
    var circles = {};
    var polylines = {};
    var kiosks = {};

    function moveToKiosk(marker_id) {
      markers[marker_id].openPopup();
      mymap.setView(markers[marker_id].getLatLng());
    };

    var editKiosk_marker_id;
    function editKiosk(marker_id) {
      kiosk_data = kiosks[marker_id];
      $('#editKioskForm_kiosk_name').val(kiosk_data['name']);
      $('#editKioskForm_kiosk_category').val(kiosk_data['category']);
      $('#editKioskForm_lat').val(kiosk_data['lat']);
      $('#editKioskForm_lng').val(kiosk_data['lng']);
      $('#showPromptEditKioskModal').modal('show');
      editKiosk_marker_id = marker_id;
    };

    function editKioskFormHandler() {
      name = $('#editKioskForm_kiosk_name').val();
      category = $('#editKioskForm_kiosk_category').val();
      lat = parseFloat($('#editKioskForm_lat').val());
      lng = parseFloat($('#editKioskForm_lng').val());
      kiosks[editKiosk_marker_id] = {'name': name, 'category': category, 'lat': lat, 'lng': lng};
      $('#panel_name_'+editKiosk_marker_id).text(name);
      $('#panel_category_'+editKiosk_marker_id).text(category);
      $('#panel_loc_'+editKiosk_marker_id).text(lat.toFixed(5) + ";" + lng.toFixed(5));
      markers[editKiosk_marker_id].bindPopup('<b>Name:</b> '+ kiosks[editKiosk_marker_id]['name'] +'</span><br /><b>Category:</b> '+ kiosks[editKiosk_marker_id]['category'] +'</span><br /><b>Location:</b> ' + kiosks[editKiosk_marker_id]['lat'].toFixed(5) + ";" + kiosks[editKiosk_marker_id]['lng'].toFixed(5) + '</span>');

      $('#showPromptEditKioskModal').modal('hide');
    }

    function deleteKiosk(marker_id) {
      markerLayerGroup.removeLayer(markers[marker_id]);
      circleLayerGroup.removeLayer(circles[marker_id]);
      delete markers[marker_id];
      delete circles[marker_id];
      // Route Network is not up to date, must first connect kiosks before running simulation
      // Make sure to enable connect kiosks button
      $('#simulate_trips_button').prop('disabled', true);
      $('#connect_kiosks_button').prop('disabled', false);

      $("#panel_"+marker_id).remove();
      if (Object.keys(markers).length == 1) {
        $("#routenetwork").hide();
      }
    }

    function selectKioskLocationOnMapHandler() {
      $('#showPromptNewKioskModal').modal('hide');
      $('#kiosks').hide();
      mymap.off('click');
      mymap.on('click', function (e) {
        $('#showPromptNewKioskModalBodyLat').val(e.latlng.lat);
        $('#showPromptNewKioskModalBodyLng').val(e.latlng.lng);
        $('#kiosks').show();
        $('#showPromptNewKioskModal').modal('show');
        mymap.off('click');
        mymap.on('click', addLocationsToAvoid);
      });
    }

    function editKioskLocationOnMapHandler() {
      $('#showPromptEditKioskModal').modal('hide');
      $('#kiosks').hide();
      mymap.off('click');
      mymap.on('click', function (e) {
        $('#editKioskForm_lat').val(e.latlng.lat);
        $('#editKioskForm_lng').val(e.latlng.lng);
        $('#kiosks').show();
        $('#showPromptEditKioskModal').modal('show');
        mymap.off('click');
        mymap.on('click', addLocationsToAvoid);
      });
    }

    function createNewKioskFormHandler() {
      name = $('#kiosk_name').val();
      category = $('#kiosk_category').val();
      lat = parseFloat($('#showPromptNewKioskModalBodyLat').val());
      lng = parseFloat($('#showPromptNewKioskModalBodyLng').val());
      placeKiosk(name, category, lat, lng);
      $('#showPromptNewKioskModal').modal('hide');
    }

    function getNearestCoord(lat, lng, callback) {
      var submitData = {
        "lat": lat,
        "lng": lng
      }

      let marker_lat;
      let marker_lng;

      request_get_nearest_coordinates = $.ajax(
        {
          url: '/get_nearest_coordinates',
          data: submitData,
          dataType: 'json',
          success: function(response) {
            marker_lat = response["lat"];
            marker_lng = response["lng"];
            name = response["name"];
            callback(marker_lat, marker_lng, name);
          }
        }
      );
    }

    var markerLayerGroup = L.layerGroup().addTo(mymap);
    var circleLayerGroup = L.layerGroup().addTo(mymap);
    function placeKiosk(input_name, category, lat, lng) {
      $('#routenetwork').show();
      // Route Network is not up to date, must first connect kiosks before running simulation
      // Make sure to enable connect kiosks button
      $('#simulate_trips_button').prop('disabled', true);
      $('#connect_kiosks_button').prop('disabled', false);

      getNearestCoord(lat, lng, function(lat, lng, name) {
        if (input_name == false) {
          placeMarkerOnMap(name, category, lat, lng);
        }
        else {
          placeMarkerOnMap(input_name, category, lat, lng);
        }
      });

    };

    function placeMarkerOnMap(name, category, lat, lng) {
      var marker = L.marker([lat, lng], {
        draggable: true,
        autoPan: true,
      }).addTo(markerLayerGroup);
      kiosks[marker._leaflet_id] = {'name': name, 'category': category, 'lat': lat, 'lng': lng};

      marker.bindPopup('<b>Name:</b> '+ kiosks[marker._leaflet_id]['name'] +'</span><br /><b>Category:</b> '+ kiosks[marker._leaflet_id]['category'] +'</span><br /><b>Location:</b> ' + kiosks[marker._leaflet_id]['lat'].toFixed(5) + ";" + kiosks[marker._leaflet_id]['lng'].toFixed(5) + '</span>');

      marker.on('drag', function(e){
        circles[marker._leaflet_id].setLatLng([e.latlng.lat, e.latlng.lng]);
        $('#panel_loc_'+marker._leaflet_id).text(e.latlng.lat.toFixed(5) + ";" + e.latlng.lng.toFixed(5));
        kiosks[marker._leaflet_id]['lat'] = e.latlng.lat;
        kiosks[marker._leaflet_id]['lng'] = e.latlng.lng;
        marker.bindPopup('<b>Name:</b> '+ kiosks[marker._leaflet_id]['name'] +'</span><br /><b>Category:</b> '+ kiosks[marker._leaflet_id]['category'] +'</span><br /><b>Location:</b> ' + kiosks[marker._leaflet_id]['lat'].toFixed(5) + ";" + kiosks[marker._leaflet_id]['lng'].toFixed(5) + '</span>');
      });
      markers[marker._leaflet_id] = marker;
      // marker.on('click', function(e){
      //   if (markers_selected.length == 2) {
      //     markers_selected.shift().setOpacity(1);
      //   }
      //   markers_selected.push(marker);
      //   marker.setOpacity(0.5);
      //   if (markers_selected.length >= 1) {
      //     let curr_marker = markers_selected[0];
      //     $('#connectKiosksDiv_marker1').text(kiosks[curr_marker._leaflet_id]['name']);
      //   }
      //   if (markers_selected.length == 2) {
      //     let curr_marker = markers_selected[1];
      //     $('#connectKiosksDiv_marker2').text(kiosks[curr_marker._leaflet_id]['name']);
      //   }
      // });
      marker.on('dragend', function(e){
        var latlng = e.target.getLatLng();
        getNearestCoord(latlng.lat, latlng.lng, function(lat, lng) {
          // Route Network is not up to date, must first connect kiosks before running simulation
          // Make sure to enable connect kiosks button
          $('#simulate_trips_button').prop('disabled', true);
          $('#connect_kiosks_button').prop('disabled', false);

          marker.setLatLng([lat, lng]);
          circles[marker._leaflet_id].setLatLng([lat, lng]);
          $('#panel_loc_'+marker._leaflet_id).text(lat.toFixed(5) + ";" + lng.toFixed(5));
          kiosks[marker._leaflet_id]['lat'] = lat;
          kiosks[marker._leaflet_id]['lng'] = lng;
          marker.bindPopup('<b>Name:</b> '+ kiosks[marker._leaflet_id]['name'] +'</span><br /><b>Category:</b> '+ kiosks[marker._leaflet_id]['category'] +'</span><br /><b>Location:</b> ' + kiosks[marker._leaflet_id]['lat'].toFixed(5) + ";" + kiosks[marker._leaflet_id]['lng'].toFixed(5) + '</span>');
        });
      });
      var circle = L.circle([lat, lng], {
        color: 'red',
        fillColor: '#f03',
        fillOpacity: 0.3,
        radius: 402.336, // 0.25 miles in meters
        interactive: false
      }).addTo(circleLayerGroup);
      circles[marker._leaflet_id] = circle;

      $("#listkiosks").append('<div class="panel-body" id="panel_'+marker._leaflet_id+'"><button type="button" class="btn btn-outline-info" onclick="moveToKiosk('+ marker._leaflet_id +')"><b>Name:</b> <span id="panel_name_' +marker._leaflet_id+ '">'+ name +'</span><br /><b>Category:</b> <span id="panel_category_' +marker._leaflet_id+ '">'+ category +'</span><br /><b>Location:</b> <span id="panel_loc_' + marker._leaflet_id + '">' + lat.toFixed(5) + ";" + lng.toFixed(5) + '</span></button><button onclick="editKiosk('+marker._leaflet_id+')"><i class="fa-solid fa-pen-to-square fa-lg"></i></button><button onclick="deleteKiosk('+marker._leaflet_id+')"><i class="fa-solid fa-trash-can fa-lg"></i></button></div>');
    }

    function createNewPOISuccess(response) {
      if (response["success"]) {
        let lat = response["lat"];
        let lng = response["lng"];
        var marker = L.marker([lat, lng], {
          draggable: true,
          autoPan: true,
          icon: redMarker
        }).bindPopup('<b>Name:</b> '+ response["name"]).addTo(mymap);
      }
      else {
        alert("Address geocoding failed. Please try again.");
      }
    }

    function createNewPOIFormHandler() {
      name = $('#POI_name').val();
      address = $('#POI_address').val();
      $('#showPromptNewPOIModal').modal('hide');

      var submitData = {
        "name": name,
        "address": address
      }

      request_new_POI = $.ajax({
        url: "/get_geocoded_address",
        data: submitData,
        dataType: 'json',
        success: createNewPOISuccess
      });
    }

    function renderHeatmap(response) {
      var heatmap_data = response;
      var cfg = {
        // radius should be small ONLY if scaleRadius is true (or small radius is intended)
        // if scaleRadius is false it will be the constant radius used in pixels
        "radius": 50,
        "maxOpacity": .8,
        // scales the radius based on map zoom
        "scaleRadius": false,
        // if set to false the heatmap uses the global maximum for colorization
        // if activated: uses the data maximum within the current map boundaries
        //   (there will always be a red spot with useLocalExtremas true)
        "useLocalExtrema": false,
        // which field name in your data represents the latitude - default "lat"
        latField: 'lat',
        // which field name in your data represents the longitude - default "lng"
        lngField: 'lng',
        // which field name in your data represents the data value - default "value"
        valueField: 'count'
      };
      var heatmapLayer = new HeatmapOverlay(cfg);
      heatmapLayer.addTo(mymap);
      heatmapLayer.setData(heatmap_data);
      $('#loading_heatmap_icon').hide();
    };


    function makeTableHTML(myArray) {
      var result = "<table class='table table-bordered w-auto'>";
      for(var i=0; i<myArray.length; i++) {
          result += "<tr>";
          for(var j=0; j<myArray[i].length; j++){
              result += "<td>"+myArray[i][j]+"</td>";
          }
          result += "</tr>";
      }
      result += "</table>";

      return result;
    }


    // var curr_route_key;
    // var duration_table_view = 'minutes';
    // function updateDurationTable() {
    //   if (duration_table_view == 'minutes') {
    //     $('#distancematrix').html(makeTableHTML(routes_dict[curr_route_key].duration_matrix_minutes));
    //   }
    //   else {
    //     $('#distancematrix').html(makeTableHTML(routes_dict[curr_route_key].duration_matrix_multiple));
    //   }
    // }

    // function cleanRouteDicts() {
    //   var lst_latlngs = [];
    //   for (let key in markers) {
    //     latlng = markers[key].getLatLng();
    //     lst_latlngs.push([latlng.lat, latlng.lng]);
    //   }
    //   for (key in routes_dict) {
    //     str_lat_lng1 = key.split(";")[0].split(",");
    //     lat_lng1 = [parseFloat(str_lat_lng1[0]), parseFloat(str_lat_lng1[1])];
    //     str_lat_lng2 = key.split(";")[1].split(",");
    //     lat_lng2 = [parseFloat(str_lat_lng2[0]), parseFloat(str_lat_lng2[1])];
    //     if (!(lst_latlngs.some(elem => JSON.stringify(elem) === JSON.stringify(lat_lng1)) && lst_latlngs.some(elem => JSON.stringify(elem) === JSON.stringify(lat_lng2)))) {
    //       delete routes_dict[key];
    //     }
    //   }
    // }

    // var total_distance = 0;
    //
    // var routeLayerGroup = L.layerGroup().addTo(mymap);
    // function renderRoutes() {
    //   cleanRouteDicts();
    //   total_distance = 0;
    //   routeLayerGroup.clearLayers();
    //   for (let key in routes_dict) {
    //     let latlngs = routes_dict[key].latlngs;
    //     let distance = routes_dict[key].distance / 1609.34; // convert from meters to miles
    //     total_distance += distance;
    //     let duration = routes_dict[key].duration / 60; // convert from seconds to minutes
    //     var polyline = L.polyline(latlngs, {color: 'blue', weight: 3}).bindTooltip("Distance: <b>"+distance.toFixed(2)+" miles</b><br>Duration: <b>"+duration.toFixed(2)+" minutes</b>", {
    //     	sticky: true
    //     }).addTo(routeLayerGroup);
    //     polyline.on('mouseover', function(e) {
    //       var layer = e.target;
    //       layer.setStyle({
    //           color: 'red',
    //           weight: 5
    //       });
    //     });
    //     polyline.on('mouseout', function(e) {
    //       var layer = e.target;
    //       layer.setStyle({
    //           color: 'blue',
    //           weight: 3
    //       });
    //     });
    //   }
    //   $('#num_road_miles').text(total_distance.toFixed(2));
    //   //updateDurationTable();
    // }


    var request_routes = null;
    // var markers_selected = [];
    function getRoute() {
      if (markers.length < 2) {
        alert("Must have at least two markers to make road network.");
        return;
      }

      $('#loading_road_network_icon').show();


      var lst_marker_latlngs = [];
      for (let key in markers) {
        latlng = markers[key].getLatLng();
        lst_marker_latlngs.push([latlng.lat, latlng.lng]);
      };

      var submitData = {
        "lst_latlngs": lst_marker_latlngs
      }

      request_routes = $.ajax({
        type: "POST",
        url: "/get_route",
        data: JSON.stringify(submitData),
        contentType: "application/json",
        dataType: 'json',
        success: drawRoute
      });
      // let marker1 = markers_selected[0];
      // let marker2 = markers_selected[1];
      // if (marker1 == marker2) {
      //   alert("Cannot connect a marker to itself.");
      // }
      // else {
      //   var avoidLocationsArray = [];
      //   avoidLocationsLayerGroup.eachLayer(function (marker) {
      //       avoidLocationsArray.push({'lat': marker.getLatLng().lat, 'lon': marker.getLatLng().lng});
      //   });
      //   var submitData = {
      //     "latlng1": [marker1.getLatLng().lat, marker1.getLatLng().lng],
      //     "latlng2": [marker2.getLatLng().lat, marker2.getLatLng().lng],
      //     "avoidLocations": avoidLocationsArray
      //   };
      //
      //   console.log(submitData);
      //
      //   request_routes = $.ajax({
      //     type: "POST",
      //     url: "/get_route",
      //     data: JSON.stringify(submitData),
      //     contentType: "application/json",
      //     dataType: 'json',
      //     success: drawRoute
      //   });
      // }
    }

    var total_distance = 0;
    var polylineLayerGroup = L.layerGroup().addTo(mymap);
    var routes_dict = {};
    function drawRoute(response) {
      polylineLayerGroup.clearLayers();
      routes_dict = response;
      for (let key in response) {
        if (response[key].distance != 0) {
          // Render polyline
          let latlngs = response[key].latlngs;
          let distance = response[key].distance / 1609.34;
          total_distance += distance;
          let duration = response[key].duration / 60; // convert from seconds to minutes
          var polyline = L.polyline(latlngs, {color: 'blue', weight: 3}).bindTooltip("Distance: <b>"+distance.toFixed(2)+" miles</b><br>Duration: <b>"+duration.toFixed(2)+" minutes</b>", {
            sticky: true
          }).addTo(polylineLayerGroup);
          polyline.on('mouseover', function(e) {
            var layer = e.target;
            layer.setStyle({
                color: 'red',
                weight: 5
            });
          });
          polyline.on('mouseout', function(e) {
            var layer = e.target;
            layer.setStyle({
                color: 'blue',
                weight: 3
            });
          });
          // Route Network is up to date, enable simulation button and disable connect kiosks button
          $('#simulate_trips_button').prop('disabled', false);
          $('#connect_kiosks_button').prop('disabled', true);

          // Hide the connecting kiosks loading icon
          $('#loading_road_network_icon').hide();

          // polyline.on('click', function(e){
          //   polylineLayerGroup.removeLayer(polyline);
          //   delete routes_dict[key];
          //   total_distance -= distance;
          //   $('#num_road_miles').text(total_distance.toFixed(2));
          // });
          $('#num_road_miles').text(total_distance.toFixed(2));

          // // Reset markers_selected
          // let marker = markers_selected.shift();
          // marker.setOpacity(1);
          // marker.closePopup();
          // marker = markers_selected.shift();
          // marker.setOpacity(1);
          // marker.closePopup();
        }
      }
    }

    function drawPixelGridHandler(response) {
      pixelGridFeatureGroup.clearLayers();
      L.geoJSON(response["pixel_grid_geojson"], {
          style: function (feature) {
              return {
                weight: 1,
                opacity: 0.5
              };
          }
      }).addTo(pixelGridFeatureGroup);
    }


    var pixelGridFeatureGroup = L.featureGroup().addTo(mymap);
    function drawPixelGrid() {
      var combined_bounds = L.latLngBounds(regionsFeatureGroup.getBounds());
      combined_bounds.extend(drawnItems.getBounds());

      console.log(combined_bounds);

      var submitData = {
        "north": combined_bounds.getNorth(),
        "south": combined_bounds.getSouth(),
        "east": combined_bounds.getEast(),
        "west": combined_bounds.getWest(),
      }

      request_draw_pixel_grid = $.ajax({
        url: "/get_pixel_grid",
        data: submitData,
        dataType: 'json',
        success: drawPixelGridHandler
      });
    }

    function getAutoKiosks() {
      extractFiles();
    }

    function drawAutoKiosksHandler(response) {
      $('#loading_kiosks_icon').hide();
      console.log(response);
      markers = {};
      markerLayerGroup.clearLayers();
      circles = {};
      circleLayerGroup.clearLayers();
      kiosks = {};
      // Route Network is not up to date, must first connect kiosks before running simulation
      // Make sure to enable connect kiosks button
      $('#simulate_trips_button').prop('disabled', true);
      $('#connect_kiosks_button').prop('disabled', false);

      var arrayLength = response["lst_marker_latlngs"].length;
      for (var i = 0; i < arrayLength; i++) {
        let latlng = response["lst_marker_latlngs"][i];
        placeKiosk(false, "unknown", latlng[0], latlng[1]);
      }
      setPixelPopup(response["dict_pixel_info"]);
      //getHeatmap(response["dict_pixel_info"]);
    }

    function drawAutoKiosks() {
      var combined_bounds = L.latLngBounds(regionsFeatureGroup.getBounds());
      combined_bounds.extend(drawnItems.getBounds());

      var submitData = {
        "north": combined_bounds.getNorth(),
        "south": combined_bounds.getSouth(),
        "east": combined_bounds.getEast(),
        "west": combined_bounds.getWest(),
        "regions_osm_geojsons": regions_osm_geojsons,
      }

      request_draw_precalculated_kiosks = $.ajax(
        {
          type: "POST",
          url: "/draw_precalculated_kiosks",
          data: JSON.stringify(submitData),
          contentType: "application/json",
          dataType: 'json',
          success: drawAutoKiosksHandler
        }
      );
    }


    function extractFilesHandler(response) {
      drawAutoKiosks();
    }

    function extractFiles() {
      var lst_county_state = [];
      for (const geojson of regions_osm_geojsons) {
        if ("address" in geojson["properties"]) {
          var addr = geojson["properties"]["address"];
          lst_county_state.push([addr["county"], addr["state"]]);
        }
      }
      console.log(lst_county_state);

      var submitData = {
        "lst_county_state": lst_county_state,
      }

      request_person_trips_extract = $.ajax(
        {
          type: "POST",
          url: "/extract_files",
          data: JSON.stringify(submitData),
          contentType: "application/json",
          dataType: 'json',
          success: extractFilesHandler
        }
      );
    };

    function setPixelPopup(dict_pixel_info) {
      pixelGridFeatureGroup.eachLayer(function (layer) {
        layer.eachLayer(function (inside_layer) {
          let xcoord = inside_layer.feature.properties.x_coord;
          let ycoord = inside_layer.feature.properties.y_coord;
          let key = "("+xcoord+", "+ycoord+")";
          if (key in dict_pixel_info) {
            let sumOTrips = dict_pixel_info[key]["sumOTrips"];
            let sumDTrips = dict_pixel_info[key]["sumDTrips"];
            console.log([sumOTrips, sumDTrips]);
            inside_layer.bindTooltip("Pixel: " + xcoord + ", " + ycoord + "<br/>Sum OTrips: " + sumOTrips + "<br/>Sum DTrips: " + sumDTrips, {
              sticky: true
            });
            inside_layer.setStyle({
              color: 'orange',
            });
          }
        });
      });
    }

    function getHeatmap(dict_pixel_info) {
      var submitData = {
        "dict_pixel_info": dict_pixel_info
      }
      request_heatmap = $.ajax(
        {
          type: 'GET',
          url: '/get_heatmap',
          success: renderHeatmap
        }
      );
    }

    var request_submit_kiosks = null;
    $("#createAnimationForm").submit(function(e) {
      e.preventDefault();
      submitKiosks();
    });

    function submitKiosksHandler(response) {
      $('#submitModalBody').html("<p>Runtime: "+ response['runtime'].toFixed(1) +" seconds</p><br />Proceed to <a href='/animation?odd_choice="+response['odd_choice']+"'>animation</a>");
    }

    function submitKiosks() {
      if (routes_dict.length == 0) {
        alert("Make sure to generate road network first.");
        return;
      }
      var lst_marker_latlngs = [];
      for (let key in markers) {
        latlng = markers[key].getLatLng();
        lst_marker_latlngs.push([latlng.lat, latlng.lng]);
      };

      var combined_bounds = L.latLngBounds(regionsFeatureGroup.getBounds());
      combined_bounds.extend(drawnItems.getBounds());

      let center_coordinates_lat = (combined_bounds.getNorth() + combined_bounds.getSouth())/2;

      let center_coordinates_lng = (combined_bounds.getEast() + combined_bounds.getWest())/2;

      center_coordinates["lat"] = center_coordinates_lat;
      center_coordinates["lng"] = center_coordinates_lng;

      saveODD();

      var polylinesGeoJSON = polylineLayerGroup.toGeoJSON();
      var submitData = {
        "odd_choice_dir": odd_choice_dir,
        "center_coordinates": center_coordinates,
        "kiosks_dict": kiosks,
        "routes_dict": routes_dict,
        "fleetsize": $('#fleetsize').val(),
        "modesplit": $('#modesplit').val(),
        "pax_waittime_threshold": $("#pax_waittime_threshold").val(),
        "max_circuity": $("#max_circuity").val(),
        "max_capacity": $("#max_capacity").val(),
        "polylinesGeoJSON": polylinesGeoJSON
      };

      console.log(submitData);

      request_submit_kiosks = $.ajax({
        type: "POST",
        url: "/create_simulation",
        data: JSON.stringify(submitData),
        contentType: "application/json",
        dataType: 'json',
        success: submitKiosksHandler
      });
    }

    function saveODDHandler(response) {
      console.log(response['message']);
    }

    var request_save_ODD = null;
    function saveODD() {
      var avoidLocationsGeoJSON = avoidLocationsLayerGroup.toGeoJSON();
      var markersGeoJSON = markerLayerGroup.toGeoJSON();
      var circlesGeoJSON = circleLayerGroup.toGeoJSON();
      var polylinesGeoJSON = polylineLayerGroup.toGeoJSON();


      var setup_interactive_dict = {
        "avoidLocationsGeoJSON": avoidLocationsGeoJSON,
        "markersGeoJSON": markersGeoJSON,
        "circlesGeoJSON": circlesGeoJSON,
        "polylinesGeoJSON": polylinesGeoJSON,
      }

      var meta_data_dict = {
        "ODD_name": $("#odd_name").val(),
      }

      var submitData = {
        "odd_choice_dir": odd_choice_dir,
        "setup_interactive_dict": setup_interactive_dict,
        "meta_data_dict": meta_data_dict
      }

      request_save_ODD = $.ajax({
        type: "POST",
        url: "/save_ODD",
        data: JSON.stringify(submitData),
        contentType: "application/json",
        dataType: 'json',
        success: saveODDHandler
      });
    }

    // function loadODDHandler(response) {
    //   console.log(response["markersGeoJSON"]);
    //   if (response["status"] == "FOUND") {
    //     var avoidLocationsGeoJSON = L.geoJSON(response["avoidLocationsGeoJSON"]).addTo(mymap);
    //     for (let idx in response["markersGeoJSON"]["features"]) {
    //       let feature = response["markersGeoJSON"]["features"][idx];
    //       console.log(feature);
    //       let lnglat = feature["geometry"]["coordinates"];
    //       placeKiosk(false, "unknown", lnglat[1], lnglat[0]);
    //     }
    //   };
    // }

    // function loadODD() {
    //   var submitData = {
    //     "odd_choice_dir": odd_choice_dir,
    //   }
    //   console.log("SENDING REQUEST");
    //
    //   request_load_data = $.ajax({
    //     url: "/load_odd",
    //     data: submitData,
    //     dataType: 'json',
    //     success: loadODDHandler
    //   });
    // }

    mymap.zoomControl.setPosition('bottomright');

    L.control.scale().addTo(mymap);

    function onMapLoad() {
      return;
    }

    mymap.whenReady(onMapLoad);

  </script>
</body>

</html>
